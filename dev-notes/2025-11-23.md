# Dev Notes - 2025-11-23

## Investigation: Pomerium CLI v0.29.0+ Logging Behavior Changes

### Background
Discovered that the current version of pomerium-cli (v0.31.0) behaves differently from earlier versions:
- Logs are now output in JSON format (structured logging)
- Log output stream changed from stderr to stdout
- This affects our `connect-pomerium` library's log parsing logic

### Objective
Research and document the new pomerium-cli logging behavior to update our library accordingly.

---

## Research Findings

### 1. Version Information

**Current CLI Version (in our repo):**
```bash
$ ./bin/pomerium-cli-windows-amd64.exe --version
pomerium-cli version v0.31.0-1760473946+2dd39af
Features: ncrypt
```

**Key Version Milestones:**
- **v0.29.0** (Released: March 26, 2024) - Major logging overhaul
  - Replaced all `stdlog` (Go standard logger) with `zerolog`
  - Changed log format from plain text to JSON
  - PR #475 by @calebdoxsey

### 2. Logging Library: Zerolog

**What is zerolog?**
- Zero-allocation JSON logger for Go
- Designed for high-performance structured logging
- Default log level: InfoLevel
- Can be controlled via `LOG_LEVEL` environment variable

**Source Code Configuration:**
From `cmd/pomerium-cli/main.go`:
```go
func setupLogger() {
    log.Logger = log.Level(zerolog.InfoLevel)

    // Allow runtime level adjustment via environment variable
    if raw := os.Getenv("LOG_LEVEL"); raw != "" {
        if lvl, err := zerolog.ParseLevel(raw); err == nil {
            log.Logger = log.Logger.Level(lvl)
        }
    }

    zerolog.DefaultContextLogger = &log.Logger
}
```

**Zerolog Default Behavior:**
- The global `log.Logger` in `github.com/rs/zerolog/log` is initialized as:
  ```go
  var Logger = zerolog.New(os.Stderr).With().Timestamp().Logger()
  ```
- **Expected**: Logs should go to `stderr` by default
- **Reality**: In pomerium-cli v0.31.0, logs go to `stdout`

### 3. Output Stream Investigation

**Test Results:**
```bash
# Test 1: Both streams (stdout + stderr merged)
$ timeout 2 ./bin/pomerium-cli-windows-amd64.exe tcp tcp+https://example.com:443 --listen :19999 2>&1
{"level":"info","component":"tunnel","addr":"[::]:19999","time":"2025-11-23T00:43:55+09:00","message":"started tcp listener"}

# Test 2: stdout only (stderr redirected to /dev/null)
$ timeout 2 ./bin/pomerium-cli-windows-amd64.exe tcp tcp+https://example.com:443 --listen :19997 2>/dev/null
{"level":"info","component":"tunnel","addr":"[::]:19997","time":"2025-11-23T00:44:15+09:00","message":"started tcp listener"}

# Test 3: stderr only (stdout redirected to /dev/null)
$ timeout 2 ./bin/pomerium-cli-windows-amd64.exe tcp tcp+https://example.com:443 --listen :19998 2>&1 1>/dev/null
(no output)
```

**Conclusion:** ✅ **Logs are written to stdout, not stderr**

**Discrepancy Explanation:**
- Zerolog library defaults to `stderr`
- Pomerium-cli source code doesn't explicitly configure a writer
- BUT somewhere between v0.29.0 and v0.31.0, the output stream was changed to `stdout`
- This might be in code not visible on the main branch, or configured during build

### 4. Complete Log Message Catalog

Based on source code analysis (`tunnel/events.go`, `tunnel/tunnel.go`, `tunnel/tunnel_tcp.go`), here are **all possible log messages**:

#### A. Listener Startup
**Source:** `tunnel/tunnel.go` - `RunListener()` method
```json
{"level":"info","component":"tunnel","addr":"[::]:XXXXX","time":"2025-11-23T00:43:55+09:00","message":"started tcp listener"}
```

#### B. Connection Lifecycle
**Source:** `tunnel/events.go` - Event handlers

**Connecting:**
```json
{"level":"info","time":"...","message":"connecting"}
```

**Authentication Required:**
```json
{"level":"info","auth-url":"https://authenticate.example.com/...","time":"...","message":"auth required"}
```

**Connected:**
```json
{"level":"info","time":"...","message":"connected"}
```

**Disconnected:**
```json
{"level":"error","error":"<error message if any>","time":"...","message":"disconnected"}
```

#### C. Protocol Selection
**Source:** `tunnel/tunnel_tcp.go` - `pickTCPTunneler()` method

```json
{"level":"info","component":"pick-tcp-tunneler","time":"...","message":"tls not enabled, using http1"}
{"level":"info","component":"pick-tcp-tunneler","time":"...","message":"using http3"}
{"level":"info","component":"pick-tcp-tunneler","time":"...","message":"using http1"}
```

#### D. Error Messages
**Source:** Various files

**Failed to accept connection:**
```json
{"level":"error","component":"tunnel","error":"<error details>","time":"...","message":"temporarily failed to accept local connection"}
```

**Error serving connection:**
```json
{"level":"error","component":"tunnel","error":"<error details>","time":"...","message":"error serving local connection"}
```

**Probe request failures:**
```json
{"level":"error","component":"pick-tcp-tunneler","error":"<error details>","time":"...","message":"failed to create probe request, falling back to http1"}
{"level":"error","component":"pick-tcp-tunneler","error":"<error details>","time":"...","message":"failed to make probe request, falling back to http1"}
```

**HTTP/3 specific errors:**
```json
{"level":"error","component":"http3tunneler","error":"<error details>","time":"...","message":"error closing http3 transport"}
{"level":"warn","component":"http3tunneler","max_datagram_payload_size":1200,"datagram_size":1300,"time":"...","message":"datagram exceeded max datagram payload size and was dropped"}
```

#### E. Signal Handling (Ctrl+C)
**Source:** `cmd/pomerium-cli/main.go` - `signalContext()` function

**Signal caught:**
```json
{"level":"error","signal":"interrupt","time":"2025-11-23T00:44:15+09:00","message":"caught signal, quitting..."}
```

**Graceful shutdown failed:**
```json
{"level":"error","time":"...","message":"did not shut down gracefully, exit"}
```

#### F. Browser Authentication (Plain Text Exception)
**Source:** `authclient/authclient.go` - `runOpenBrowser()` method

**Note:** This is NOT JSON - written as plain text to stderr:
```
Your browser has been opened to visit:

https://authenticate.example.com/...

```

### 5. CLI Flags and Options

#### TCP Command Flags

**Primary Flags:**
```bash
--listen string              # Local address to start listener on (default "127.0.0.1:0")
--pomerium-url string        # URL of the Pomerium server to connect to
```

**Browser Control:**
```bash
--browser-cmd string         # Custom browser command to run when opening a URL
```

**Service Account Authentication:**
```bash
--service-account string         # Service account JWT for authentication
--service-account-file string    # File containing service account JWT
```

**TLS Options:**
```bash
--disable-tls-verification       # Disables TLS verification
--alternate-ca-path string       # Path to CA certificate
--ca-cert string                 # Base64-encoded CA TLS certificate
--client-cert string             # PEM-encoded client certificate
--client-key string              # PEM-encoded client key
--client-cert-from-store         # Load cert from system trust store [macOS/Windows]
--client-cert-issuer string      # Search trust store by Issuer name
--client-cert-subject string     # Search trust store by Subject name
```

#### Headless Mode Investigation

**❌ NO `--headless` flag exists**

**Alternative Approaches to Suppress Browser:**

1. **Service Account Authentication** (Official Method)
   ```bash
   --service-account <JWT_TOKEN>
   # OR
   --service-account-file <PATH_TO_JWT>
   ```
   When either flag is provided, the OAuth flow is skipped entirely.

2. **Custom Browser Command** (Hack - Current Implementation)
   ```bash
   --browser-cmd "true"           # Unix
   --browser-cmd "cmd /c exit"    # Windows
   ```
   Our current library uses this approach - it works but is not officially supported.

**Code Evidence:**
From `authclient/authclient.go` - `GetJWT()` method:
```go
// Check service account first
if client.cfg.serviceAccount != "" {
    return client.cfg.serviceAccount, nil
}
if client.cfg.serviceAccountFile != "" {
    bs, err := os.ReadFile(client.cfg.serviceAccountFile)
    if err != nil {
        return "", fmt.Errorf("read service account file: %w", err)
    }
    return string(bs), nil
}
// Only reaches browser code if both service account options are empty
```

### 6. Documentation Status

**Official Documentation:** https://www.pomerium.com/docs/deploy/clients

**Issues Found:**
- ❌ Does NOT mention JSON log format
- ❌ Does NOT specify output stream (stdout vs stderr)
- ❌ Does NOT document v0.29.0+ logging changes
- ❌ Examples show old plain-text log format
- **Conclusion:** Documentation is outdated and not updated since v0.29.0 release (March 2024)

### 7. Source Code Locations

**Key Files:**

1. **Logger Setup:**
   - `cmd/pomerium-cli/main.go` - `setupLogger()` function

2. **Event-Based Logs:**
   - `tunnel/events.go` - Connection lifecycle events
   - `OnConnecting()`, `OnConnected()`, `OnAuthRequired()`, `OnDisconnected()`

3. **Listener Logs:**
   - `tunnel/tunnel.go` - `RunListener()` method

4. **Protocol Selection:**
   - `tunnel/tunnel_tcp.go` - `pickTCPTunneler()` method

5. **Authentication:**
   - `authclient/authclient.go` - Browser launch and JWT handling

6. **Signal Handling:**
   - `cmd/pomerium-cli/main.go` - `signalContext()` function

---

## Impact on Our Library

### Current Implementation Issues

**File:** `src/PomeriumTunnel.ts`

**Problem 1: Wrong Stream** ❌
```typescript
// Line 186 - Currently listening to stderr
this.process.stderr?.on('data', async (chunk) => {
  const message = chunk.toString();
  // ...
});
```

**Should be:**
```typescript
this.process.stdout?.on('data', async (chunk) => {
  const message = chunk.toString();
  // ...
});
```

**Problem 2: Broken String Matching** ❌

| Current Check | Expected String | Actual JSON |
|--------------|----------------|-------------|
| Line 191: `message.includes('listening on')` | "listening on" | `{"message":"started tcp listener"}` |
| Line 215: `message.includes('connection established')` | "connection established" | `{"message":"connected"}` |
| Line 237: `message.includes('connection closed')` | "connection closed" | `{"message":"disconnected"}` |
| Line 199: `message.includes('https')` + regex | Works but unreliable | `{"auth-url":"https://..."}` |

**All string matching logic is broken** because:
- Old format: Plain text with human-readable messages
- New format: JSON with structured fields and different message strings

---

## Recommended Changes

### Phase 1: Fix Output Stream (Critical)

**Change from:**
```typescript
this.process.stderr?.on('data', async (chunk) => { ... })
```

**To:**
```typescript
this.process.stdout?.on('data', async (chunk) => { ... })

// Optionally listen to stderr for debug/errors
this.process.stderr?.on('data', (chunk) => {
  console.error('pomerium-cli stderr:', chunk.toString());
});
```

### Phase 2: Implement JSON Log Parser (Critical)

**Create:** `src/utils/log-parser.ts`
```typescript
export interface PomeriumLogEntry {
  level: 'info' | 'error' | 'warn' | 'debug';
  message: string;
  component?: string;
  addr?: string;
  'auth-url'?: string;
  error?: string;
  signal?: string;
  time?: string;
  [key: string]: unknown;
}

export function parsePomeriumLog(line: string): PomeriumLogEntry | null {
  try {
    return JSON.parse(line) as PomeriumLogEntry;
  } catch {
    return null;
  }
}

export function extractAuthUrl(line: string): string | null {
  // Fallback for plain text browser message
  const match = line.match(/https?:\/\/[^\s\n]+/);
  return match ? match[0] : null;
}
```

**Update:** `src/PomeriumTunnel.ts`
```typescript
this.process.stdout?.on('data', async (chunk) => {
  const lines = chunk.toString().split('\n');

  for (const line of lines) {
    if (!line.trim()) continue;

    const logEntry = parsePomeriumLog(line);
    if (logEntry) {
      // Handle based on message field
      switch (logEntry.message) {
        case 'started tcp listener':
          // Listener started - test connection
          const addr = logEntry.addr;
          testLocalConnection(this.config.listenPort).catch(...);
          break;

        case 'auth required':
          // Authentication needed
          const authUrl = logEntry['auth-url'];
          if (authUrl && this.config.onAuthRequired) {
            await this.config.onAuthRequired(authUrl);
          }
          break;

        case 'connected':
          // Connection established
          if (!connectionEstablished) {
            connectionEstablished = true;
            this.state.connected = true;
            this.clearConnectionTimeout();
            this.setupSignalHandlers();
            this.config.onConnected?.();
            resolve();
          }
          break;

        case 'disconnected':
          // Connection lost
          if (this.state.connected) {
            this.state.connected = false;
            const errorMsg = logEntry.error;
            this.config.onDisconnected?.();
            if (this.config.autoReconnect && !this.shuttingDown) {
              this.attemptReconnect();
            }
          }
          break;

        case 'caught signal, quitting...':
          // Graceful shutdown initiated
          break;
      }
    } else {
      // Not JSON - check for plain text auth URL (fallback)
      const authUrl = extractAuthUrl(line);
      if (authUrl && this.config.onAuthRequired) {
        await this.config.onAuthRequired(authUrl);
      }
    }
  }
});
```

### Phase 3: Better Browser Suppression (Optional)

**Current approach works** (using `--browser-cmd "true"` / `"cmd /c exit"`), but consider adding service account support:

```typescript
export interface PomeriumTunnelConfig {
  // ... existing fields ...

  /**
   * Optional: Service account JWT for authentication
   * If provided, browser-based OAuth flow is skipped entirely
   */
  serviceAccount?: string;

  /**
   * Optional: Path to file containing service account JWT
   * If provided, browser-based OAuth flow is skipped entirely
   */
  serviceAccountFile?: string;
}

// In args building:
if (this.config.serviceAccount) {
  args.push('--service-account', this.config.serviceAccount);
} else if (this.config.serviceAccountFile) {
  args.push('--service-account-file', this.config.serviceAccountFile);
} else if (this.config.onAuthRequired) {
  args.push('--browser-cmd', getBrowserSuppressCommand());
}
```

### Phase 4: Logging Improvements (Nice-to-Have)

**Add log level control:**
```typescript
export interface PomeriumTunnelConfig {
  // ... existing fields ...

  /**
   * Optional: Log level for pomerium-cli
   * @default 'info'
   */
  logLevel?: 'debug' | 'info' | 'warn' | 'error';

  /**
   * Optional: Callback to receive raw log entries
   */
  onLog?: (log: PomeriumLogEntry) => void;
}

// In spawn options:
const env = { ...process.env };
if (this.config.logLevel) {
  env.LOG_LEVEL = this.config.logLevel;
}

this.process = spawn(binaryPath, args, { env });
```

---

## Breaking Changes Required

### Version Bump
- Current: `1.0.1`
- Next: `2.0.0` (major version bump due to breaking changes)

### Why Breaking?
1. **Minimum CLI version requirement:** v0.29.0+ (March 2024)
2. **Behavioral changes:** Log parsing completely rewritten
3. **Stream change:** stdout instead of stderr

### Migration Guide for Users

**Before (v1.x):**
- Worked with any pomerium-cli version
- Log parsing was fragile but functional

**After (v2.x):**
- **Requires:** pomerium-cli v0.29.0 or later (released March 2024)
- More reliable log parsing via JSON
- Better error messages with structured data

**User Action Required:**
```bash
# Update pomerium-cli binary to v0.29.0+
# Download from: https://github.com/pomerium/cli/releases
```

---

## Testing Plan

### 1. Manual Testing
```bash
# Test with actual pomerium-cli v0.31.0
cd f:\repository\connect-pomerium
npm run build
npx tsx examples/01-basic-manual-auth.ts
```

### 2. Unit Tests
- Update `src/PomeriumTunnel.test.ts` to:
  - Mock stdout instead of stderr
  - Use JSON log format in mock data
  - Test all log message types from catalog

### 3. Integration Tests
- Test with real pomerium-cli binary
- Verify all log messages are captured
- Confirm auth URL extraction
- Test reconnection logic

---

## Timeline Estimate

| Phase | Task | Time Estimate |
|-------|------|---------------|
| 1 | Create log parser utility | 1 hour |
| 2 | Update PomeriumTunnel.ts (stdout + JSON parsing) | 2-3 hours |
| 3 | Update tests | 2 hours |
| 4 | Update README and documentation | 1 hour |
| 5 | Manual testing and validation | 1-2 hours |
| **Total** | | **7-9 hours** |

**Optional enhancements:** +2-4 hours (service accounts, log level control, etc.)

---

## Documentation Updates Needed

### README.md
1. Add requirement: "Requires pomerium-cli v0.29.0 or later"
2. Update log format examples to show JSON
3. Add troubleshooting section for version compatibility
4. Document LOG_LEVEL environment variable

### CHANGELOG.md
```markdown
## [2.0.0] - 2025-11-23

### Breaking Changes
- **REQUIRES pomerium-cli v0.29.0 or later** (released March 2024)
- Changed log parsing to handle JSON format (zerolog)
- Listen to stdout instead of stderr for CLI logs

### Fixed
- Log parsing now works correctly with pomerium-cli v0.29.0+
- More reliable detection of connection states
- Proper error message extraction from structured logs

### Added
- JSON log parser utility
- Structured log entry type definitions
- Better error details from CLI logs

### Migration Guide
If using older pomerium-cli binaries (< v0.29.0):
- Update to v0.29.0+ from https://github.com/pomerium/cli/releases
- Or stay on connect-pomerium v1.x (not recommended)
```

---

## Resources and References

### GitHub Repositories
- [pomerium/cli](https://github.com/pomerium/cli) - Main CLI repository
- [rs/zerolog](https://github.com/rs/zerolog) - Logging library

### Pull Requests & Issues
- [PR #475](https://github.com/pomerium/cli/pull/475) - Standardize logging with zerolog
- [PR #2586](https://github.com/pomerium/pomerium/pull/2586) - Update TCP log output format

### Documentation
- [Pomerium CLI Releases](https://github.com/pomerium/cli/releases) - Release history
- [Zerolog Package Docs](https://pkg.go.dev/github.com/rs/zerolog/log) - Library documentation
- [Pomerium Client Docs](https://www.pomerium.com/docs/deploy/clients) - Official docs (outdated)

### Related Articles
- [Zerolog Complete Guide](https://betterstack.com/community/guides/logging/zerolog/)
- [Node.js Child Process Streams](https://nodejs.org/api/child_process.html)
- [Stdout vs Stderr Best Practices](https://stackoverflow.com/questions/3385201/confused-about-stdin-stdout-and-stderr)

---

## Key Learnings

### 1. Always Test Empirically
- **Mistake:** Relied on source code analysis and library defaults
- **Reality:** Actual binary behavior differed from expectations
- **Lesson:** Test with the actual binary first, then investigate why

### 2. Documentation Lags Behind Code
- Official Pomerium docs haven't been updated since March 2024
- Always verify with source code and actual testing
- Don't trust documentation for rapidly evolving projects

### 3. Structured Logging is Better
- JSON logs are easier to parse reliably
- Extract more information (error details, addresses, etc.)
- Future-proof against message string changes

### 4. Stream Conventions Don't Always Hold
- "Logs should go to stderr" is a convention, not a law
- Zerolog defaults to stderr, but applications can override
- Always verify actual behavior

### 5. Version Pinning Matters
- CLI behavior changed significantly between versions
- Need to document minimum version requirements
- Consider adding version detection in library

---

## Next Steps

1. ✅ Document findings (this file)
2. ⏳ Implement log parser utility
3. ⏳ Update PomeriumTunnel.ts with JSON parsing
4. ⏳ Update tests
5. ⏳ Update documentation (README, CHANGELOG)
6. ⏳ Manual testing with real CLI
7. ⏳ Version bump to 2.0.0
8. ⏳ Publish updated package

---

## Conclusion

The pomerium-cli v0.29.0 release (March 2024) introduced significant logging changes that break our current implementation:

1. **Log format:** Plain text → JSON (zerolog)
2. **Output stream:** stderr → stdout
3. **Message strings:** Different wording ("connection established" → "connected")

**Our library must adapt** by:
- Parsing JSON logs instead of plain text
- Listening to stdout instead of stderr
- Using structured message field matching

This is a **necessary breaking change** but will make our library **more reliable and maintainable** going forward.

**Time investment:** ~7-9 hours for core changes, worth it for a production-ready solution.
